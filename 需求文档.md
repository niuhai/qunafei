# 航班价格周边机场筛选程序 - 需求文档

## 一、项目概述

### 1.1 项目背景
用户在购买机票时，所在城市的机场航班价格可能不理想。本程序旨在帮助用户自动筛选出发地周边机场的航班，通过综合比较机票价格和地面交通成本，找到最优的出行方案。

### 1.2 目标用户
- 经常出差的商务人士
- 价格敏感的旅行者
- 需要灵活选择出发机场的用户

### 1.3 典型场景
> 用户在烟台，想飞往上海。烟台蓬莱机场机票价格800元，但青岛胶东机场只需500元。扣除烟台到青岛的高铁费用（约150元），仍可节省150元。

---

## 二、功能需求

### 2.1 核心功能模块

#### 模块一：出发地配置
| 功能点 | 描述 | 优先级 |
|--------|------|--------|
| 城市输入 | 支持输入城市名称（如"烟台"），支持多选 | P0 |
| 城市选择 | 下拉选择城市列表 | P1 |
| 历史记录 | 记住用户常用出发地 | P2 |

#### 模块二：周边机场识别
| 功能点 | 描述 | 优先级 |
|--------|------|--------|
| 距离筛选 | 设置搜索半径（如200km、300km） | P0 |
| 机场列表 | 展示周边机场及距离信息，支持输入筛选 | P0 |
| 交通方式 | 显示到各机场的交通方式（自驾/高铁/大巴） | P1 |
| 时间估算 | 预估到达各机场所需时间 | P1 |

#### 模块三：航班查询
| 功能点 | 描述 | 优先级 |
|--------|------|--------|
| 目的地输入 | 支持城市/机场名称输入 | P0 |
| 日期选择 | 选择出发日期 | P0 |
| 多机场查询 | 同时查询多个出发机场的航班 | P0 |
| 航班信息 | 展示航班号、时间、航空公司、价格 | P0 |

#### 模块四：价格比较与筛选
| 功能点 | 描述 | 优先级 |
|--------|------|--------|
| 价格排序 | 按机票价格升序/降序排列 | P0 |
| 综合成本 | 机票价格 + 地面交通费用 | P0 |
| 时间筛选 | 按出发/到达时间段筛选 | P1 |
| 直飞/中转 | 筛选直飞或中转航班 | P1 |

#### 模块五：综合推荐
| 功能点 | 描述 | 优先级 |
|--------|------|--------|
| 最优推荐 | 综合价格、时间给出最优方案 | P0 |
| 方案对比 | 多个方案并列对比展示 | P1 |
| 成本明细 | 展示机票费用、交通费用明细 | P1 |

### 2.2 扩展功能（Phase 2）
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 日期灵活搜索 | 查询前后N天的价格对比 | P1 |
| 价格日历 | 日历视图展示每日最低价 | P2 |

---

## 三、技术方案

### 3.1 技术栈选型

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端 | 原生HTML/CSS/JS | 轻量级，无需构建工具 |
| 后端 | Node.js + Express | 轻量级API服务 |
| 数据存储 | JSON文件 | 零依赖，开箱即用 |
| 地图服务 | 高德地图API | 免费额度充足 |
| 航班数据 | 爬虫（携程） | 成本最低 |

### 3.2 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      单体应用架构                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Node.js + Express                    │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │  │
│  │  │ 静态文件 │ │ 航班API │ │ 机场API │ │ 计算API │    │  │
│  │  │ 服务    │ │ /flight │ │ /airport│ │/calculate│    │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘    │  │
│  │                       │                              │  │
│  │  ┌─────────────────────────────────────────────────┐│  │
│  │  │              JSON 文件数据存储                   ││  │
│  │  │  airports.json | cache.json | config.json       ││  │
│  │  └─────────────────────────────────────────────────┘│  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       外部服务                               │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │ 携程机票    │  │ 高德地图API │                          │
│  │ (爬虫)      │  │ (免费额度)  │                          │
│  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 项目目录结构

```
qunafei/
├── package.json
├── server.js                 # 入口文件
├── config/
│   └── index.js              # 配置文件（端口、API密钥等）
├── data/
│   ├── airports.json         # 机场静态数据
│   ├── cache.json            # 航班缓存数据
│   └── config.json           # 用户配置
├── routes/
│   ├── flight.js             # 航班查询路由
│   ├── airport.js            # 机场查询路由
│   └── calculate.js          # 成本计算路由
├── services/
│   ├── crawler.js            # 携程爬虫服务
│   ├── distance.js           # 距离计算服务
│   └── recommend.js          # 推荐算法服务
├── public/
│   ├── index.html            # 前端页面
│   ├── css/
│   │   └── style.css
│   └── js/
│       └── app.js
└── utils/
    ├── helpers.js            # 工具函数
    └── geo.js                # 地理计算工具
```

### 3.4 核心依赖

```json
{
  "name": "qunafei",
  "version": "1.0.0",
  "dependencies": {
    "express": "^4.18.2",
    "axios": "^1.6.0",
    "cheerio": "^1.0.0-rc.12"
  },
  "scripts": {
    "start": "node server.js",
    "dev": "node --watch server.js"
  }
}
```

**依赖说明**：
| 包名 | 用途 | 大小 |
|------|------|------|
| express | Web框架 | ~200KB |
| axios | HTTP请求 | ~300KB |
| cheerio | HTML解析（爬虫） | ~400KB |

**总计约 1MB**，极其轻量！

---

## 四、API接口设计

### 4.1 系统接口

#### GET /api/health
健康检查接口

**响应示例**：
```json
{
  "code": 0,
  "message": "ok",
  "timestamp": "2026-02-13T10:30:00Z",
  "config": {
    "amapEnabled": true,
    "port": 3000
  }
}
```

#### GET /api/config
获取前端配置信息

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "defaultRadius": 200,
    "maxRadius": 1000,
    "defaultSortBy": "totalCost",
    "cacheExpireMinutes": 60,
    "transport": {
      "car": { "costPerKm": 0.5, "speedKmh": 60 },
      "train": { "costPerKm": 0.4, "speedKmh": 200 },
      "bus": { "costPerKm": 0.3, "speedKmh": 80 }
    }
  }
}
```

### 4.2 机场相关接口

#### GET /api/airports/nearby
获取周边机场列表

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| city | string | 是 | 城市名称 |
| radius | number | 否 | 搜索半径(km)，默认200 |
| cities | string | 否 | 多城市查询，逗号分隔 |

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "airports": [
      {
        "code": "YNT",
        "name": "烟台蓬莱国际机场",
        "city": "烟台",
        "lat": 37.6644,
        "lng": 120.9341,
        "distance": 0,
        "transport": {
          "type": "local",
          "time": 0,
          "cost": 0
        }
      }
    ],
    "centerCity": "烟台"
  }
}
```

#### GET /api/airports/search
机场关键词搜索

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 搜索关键词（机场代码/名称/城市） |

**响应示例**：
```json
{
  "code": 0,
  "data": [
    {
      "code": "YNT",
      "name": "烟台蓬莱国际机场",
      "city": "烟台",
      "province": "山东"
    }
  ]
}
```

#### GET /api/airports/:code
获取单个机场详情

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "code": "YNT",
    "name": "烟台蓬莱国际机场",
    "city": "烟台",
    "province": "山东",
    "lat": 37.6644,
    "lng": 120.9341,
    "enabled": true
  }
}
```

#### GET /api/airports/cities/all
获取所有城市列表

**响应示例**：
```json
{
  "code": 0,
  "data": [
    { "name": "烟台", "province": "山东" },
    { "name": "青岛", "province": "山东" }
  ]
}
```

#### GET /api/airports/cities/search
城市关键词搜索

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 是 | 搜索关键词 |

**响应示例**：
```json
{
  "code": 0,
  "data": [
    { "name": "烟台", "province": "山东" }
  ]
}
```

### 4.3 航班查询接口

#### GET /api/flights/search
查询航班信息

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| from | string | 是 | 出发机场代码，多个用逗号分隔 |
| to | string | 是 | 目的地城市/机场 |
| date | string | 是 | 出发日期 YYYY-MM-DD |

**响应示例**：
```json
{
  "code": 0,
  "data": [
    {
      "flightNo": "SC4622",
      "airline": "山东航空",
      "from": "YNT",
      "to": "SHA",
      "depTime": "08:30",
      "arrTime": "10:15",
      "price": 680,
      "discount": 7.5,
      "isDirect": true,
      "aircraft": "Boeing 737"
    }
  ],
  "cacheTime": "2026-02-13T10:30:00Z"
}
```

### 4.3 综合计算接口

#### POST /api/calculate/recommend
综合成本计算与推荐

**请求参数**：
```json
{
  "originCity": "烟台",
  "destination": "上海",
  "date": "2026-02-20",
  "radius": 200,
  "preferences": {
    "maxTransportTime": 120,
    "sortBy": "totalCost"
  }
}
```

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "recommendations": [
      {
        "rank": 1,
        "airport": {
          "code": "TAO",
          "name": "青岛胶东国际机场",
          "distance": 200
        },
        "flight": {
          "flightNo": "MU5532",
          "depTime": "09:00",
          "price": 520
        },
        "transport": {
          "type": "高铁",
          "time": 90,
          "cost": 150
        },
        "totalCost": 670,
        "totalTime": 240,
        "savings": 130
      }
    ],
    "baseline": {
      "airport": "YNT",
      "price": 800
    }
  }
}
```

---

## 五、数据存储设计

### 5.1 存储方案

采用 **纯JSON文件** 存储，零数据库依赖：

| 文件 | 用途 | 更新频率 |
|------|------|----------|
| airports.json | 机场静态数据 | 手动更新 |
| cache.json | 航班缓存数据 | 每次查询更新 |
| config.json | 用户配置 | 用户修改时更新 |

### 5.2 数据结构

#### airports.json
```json
{
  "version": "1.0",
  "updatedAt": "2026-02-13",
  "airports": [
    {
      "code": "YNT",
      "name": "烟台蓬莱国际机场",
      "city": "烟台",
      "province": "山东",
      "lat": 37.6644,
      "lng": 120.9341,
      "enabled": true
    },
    {
      "code": "TAO",
      "name": "青岛胶东国际机场",
      "city": "青岛",
      "province": "山东",
      "lat": 36.2611,
      "lng": 119.8544,
      "enabled": true
    }
  ]
}
```

#### cache.json
```json
{
  "flights": {
    "YNT-SHA-2026-02-20": {
      "data": [...],
      "fetchedAt": "2026-02-13T10:30:00Z",
      "expiresAt": "2026-02-13T11:30:00Z"
    }
  }
}
```

#### config.json
```json
{
  "defaultRadius": 200,
  "cacheExpireMinutes": 60,
  "recentSearches": [
    {
      "from": "烟台",
      "to": "上海",
      "date": "2026-02-20"
    }
  ]
}
```

---

## 六、爬虫技术方案

### 6.1 携程机票爬虫

#### 目标URL
```
https://flights.ctrip.com/international/search/oneway-{from}-{to}?depdate={date}
```

#### 请求示例
```javascript
const axios = require('axios');
const cheerio = require('cheerio');

async function fetchFlights(from, to, date) {
  const url = `https://flights.ctrip.com/international/search/oneway-${from}-${to}?depdate=${date}`;
  
  const response = await axios.get(url, {
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
      'Accept': 'text/html,application/xhtml+xml',
      'Accept-Language': 'zh-CN,zh;q=0.9',
      'Referer': 'https://flights.ctrip.com/'
    }
  });
  
  const $ = cheerio.load(response.data);
  const flights = [];
  
  $('.flight-item').each((i, el) => {
    flights.push({
      flightNo: $(el).find('.flight-no').text().trim(),
      airline: $(el).find('.airline-name').text().trim(),
      depTime: $(el).find('.dep-time').text().trim(),
      arrTime: $(el).find('.arr-time').text().trim(),
      price: parseInt($(el).find('.price').text().replace(/[^\d]/g, '')),
      isDirect: !$(el).find('.transfer').length
    });
  });
  
  return flights;
}
```

### 6.2 反爬策略

| 策略 | 实现方式 |
|------|----------|
| 请求频率控制 | 每次请求间隔 2-5 秒随机延迟 |
| User-Agent轮换 | 维护UA池，随机选择 |
| 缓存机制 | 相同查询1小时内使用缓存 |
| 错误重试 | 失败后最多重试3次，指数退避 |

### 6.3 备选数据源

如果携程爬虫失效，可切换到：

| 数据源 | 优先级 | 说明 |
|--------|--------|------|
| 去哪儿 | 1 | 结构类似携程 |
| 航司官网 | 2 | 需要适配各航司 |
| 飞常准API | 3 | 有免费额度 |

### 6.4 高德地图API集成

#### API申请流程
1. 访问 [高德开放平台](https://lbs.amap.com/) 注册账号
2. 进入控制台 → 应用管理 → 创建新应用
3. 添加Key，选择"Web服务"类型
4. 将Key配置到 `config/index.js` 中

#### 使用的API接口

| API | 用途 | 免费额度 |
|-----|------|----------|
| 地理编码 | 城市名称→经纬度 | 30万次/日 |
| 路径规划 | 计算交通时间和距离 | 30万次/日 |
| 坐标转换 | 坐标系转换（如需要） | 30万次/日 |

#### 请求示例
```javascript
const axios = require('axios');
const AMAP_KEY = process.env.AMAP_KEY || 'your_amap_key';

async function getCityCoordinate(cityName) {
  const url = `https://restapi.amap.com/v3/geocode/geo`;
  const response = await axios.get(url, {
    params: {
      key: AMAP_KEY,
      address: cityName
    }
  });
  
  if (response.data.geocodes && response.data.geocodes.length > 0) {
    const [lng, lat] = response.data.geocodes[0].location.split(',');
    return { lat: parseFloat(lat), lng: parseFloat(lng) };
  }
  return null;
}

async function getTransportInfo(origin, destination) {
  const url = `https://restapi.amap.com/v3/direction/driving`;
  const response = await axios.get(url, {
    params: {
      key: AMAP_KEY,
      origin: `${origin.lng},${origin.lat}`,
      destination: `${destination.lng},${destination.lat}`,
      strategy: 0
    }
  });
  
  if (response.data.route && response.data.route.paths.length > 0) {
    const path = response.data.route.paths[0];
    return {
      distance: parseInt(path.distance) / 1000,
      time: parseInt(path.duration) / 60,
      toll: parseInt(path.tolls) || 0
    };
  }
  return null;
}
```

### 6.5 外部服务落地策略

#### 第一阶段：MVP版本（无外部依赖）
- 使用内置机场坐标数据（airports.json）
- 使用Haversine公式计算直线距离
- 交通费用按距离估算（自驾：0.5元/km，高铁：0.4元/km）
- 交通时间按距离估算（自驾：60km/h，高铁：200km/h）

#### 第二阶段：接入高德API
- 申请高德API Key
- 实现城市名称→坐标转换
- 实现真实路径规划（考虑道路情况）
- 获取准确的交通时间和费用

#### 第三阶段：爬虫优化
- 完善携程爬虫的稳定性
- 添加去哪儿作为备用数据源
- 实现数据缓存和增量更新

---

## 七、核心算法

### 7.1 距离计算（Haversine公式）

```javascript
function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
```

### 7.2 综合成本计算

```javascript
function calculateTotalCost(flight, transport) {
  const ticketPrice = flight.price;
  const transportCost = transport.cost;
  const timeValue = transport.time * 0.5;  // 时间成本：0.5元/分钟
  
  return {
    ticket: ticketPrice,
    transport: transportCost,
    timeValue: timeValue,
    total: ticketPrice + transportCost + timeValue
  };
}
```

### 7.3 推荐排序

```javascript
function sortRecommendations(results, preference = 'totalCost') {
  return results.sort((a, b) => {
    if (preference === 'totalCost') {
      return a.totalCost - b.totalCost;
    } else if (preference === 'totalTime') {
      return a.totalTime - b.totalTime;
    }
    return 0;
  });
}
```

---

## 八、前端交互流程

### 8.1 用户操作流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  输入出发地  │ ──▶ │  输入目的地  │ ──▶ │  选择日期   │
│  (城市名称)  │     │  (城市/机场) │     │  (日历选择) │
└─────────────┘     └─────────────┘     └─────────────┘
                                              │
                                              ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  查看推荐    │ ◀── │  计算推荐    │ ◀── │  设置半径   │
│  结果列表    │     │  (后端处理)  │     │  (可选)     │
└─────────────┘     └─────────────┘     └─────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│  点击方案    │ ──▶ │  查看详情    │
│  查看详情    │     │  (跳转购票) │
└─────────────┘     └─────────────┘
```

### 8.2 页面布局

```
┌──────────────────────────────────────────────────────────┐
│  🛫 航班价格周边机场筛选                                   │
├──────────────────────────────────────────────────────────┤
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────┐│
│  │ 出发城市   │ │ 目的地     │ │ 出发日期   │ │ 搜索   ││
│  │ [烟台    ] │ │ [上海    ] │ │ [2026-02-20]│ │ [查询] ││
│  └────────────┘ └────────────┘ └────────────┘ └────────┘│
├──────────────────────────────────────────────────────────┤
│  搜索半径: [200km ▼]  排序: [综合成本最低 ▼]             │
├──────────────────────────────────────────────────────────┤
│  🏆 推荐方案                                              │
│  ┌────────────────────────────────────────────────────┐  │
│  │ ⭐ 最优推荐: 青岛胶东机场出发                        │  │
│  │ ┌──────────┐ ┌──────────┐ ┌──────────┐            │  │
│  │ │ 机票 ¥520 │ │ 交通 ¥150 │ │ 总计 ¥670 │ 节省¥130  │  │
│  │ └──────────┘ └──────────┘ └──────────┘            │  │
│  │ 航班: MU5532 09:00-10:40  |  高铁: 烟台→青岛 90分钟 │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  其他方案                                                 │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 烟台蓬莱机场 | SC4622 08:30-10:15 | ¥680 | 直飞    │  │
│  └────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 威海大水泊机场 | CA1588 10:00-11:45 | ¥620 | +¥50交通│  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

---

## 九、项目里程碑

### Phase 1：MVP版本（1-2周）
- [x] 需求文档编写
- [ ] 项目初始化（package.json、目录结构）
- [ ] 机场数据准备（airports.json）
- [ ] 基础API实现（机场查询、距离计算）
- [ ] 携程爬虫实现
- [ ] 前端页面开发
- [ ] 综合推荐功能

### Phase 2：功能完善（1周）
- [ ] 缓存机制优化
- [ ] 错误处理完善
- [ ] 界面美化
- [ ] 移动端适配

### Phase 3：扩展功能（按需）
- [ ] 日期灵活搜索
- [ ] 价格日历
- [ ] 历史搜索记录

---

## 十、风险与对策

| 风险项 | 影响 | 对策 |
|--------|------|------|
| 爬虫被封 | 高 | 请求频率控制 + 备选数据源 |
| 数据不准 | 中 | 多数据源交叉验证 |
| 价格波动 | 低 | 提示用户价格实时变动，缓存1小时 |

---

## 十一、附录

### 11.1 中国主要机场数据（部分）

| 代码 | 名称 | 城市 | 经度 | 纬度 |
|------|------|------|------|------|
| YNT | 烟台蓬莱国际机场 | 烟台 | 120.9341 | 37.6644 |
| TAO | 青岛胶东国际机场 | 青岛 | 119.8544 | 36.2611 |
| WEH | 威海大水泊机场 | 威海 | 122.2285 | 37.1873 |
| SHA | 上海虹桥国际机场 | 上海 | 121.3361 | 31.1978 |
| PVG | 上海浦东国际机场 | 上海 | 121.8050 | 31.1434 |
| PEK | 北京首都国际机场 | 北京 | 116.5850 | 40.0725 |
| PKX | 北京大兴国际机场 | 北京 | 116.4106 | 39.5098 |

### 11.2 参考资源
- 高德地图开放平台：https://lbs.amap.com/ （申请Web服务API Key）
- 携程机票：https://flights.ctrip.com/
- OurAirports数据：https://ourairports.com/ （全球机场数据）

---

**文档版本**：v2.0  
**创建日期**：2026-02-13  
**最后更新**：2026-02-13
